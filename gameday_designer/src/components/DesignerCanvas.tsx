/**
 * DesignerCanvas Component
 *
 * Main container for the Gameday Designer that:
 * - Shows all fields in responsive columns
 * - Renders FieldColumn for each field
 * - Shows empty state message when no fields
 * - Can switch to results entry mode
 */

import React from 'react';
import { Row, Col, Alert, Button } from 'react-bootstrap';
import type { Field } from '../types/designer';
import FieldColumn from './FieldColumn';
import { GameResultsTable } from './GameResultsTable';
import { useGamedayContext } from '../context/GamedayContext';

export interface DesignerCanvasProps {
  /** All fields to display */
  fields: Field[];
  /** ID of the currently selected game slot (null if none) */
  selectedGameSlotId: string | null;
  /** Callback when field name is changed */
  onUpdateFieldName: (fieldId: string, name: string) => void;
  /** Callback when field is to be removed */
  onRemoveField: (fieldId: string) => void;
  /** Callback when Add Game button is clicked */
  onAddGameSlot: (fieldId: string) => void;
  /** Callback when a game slot is selected */
  onSelectGameSlot: (slotId: string) => void;
  /** Callback when a game slot is to be deleted */
  onDeleteGameSlot: (slotId: string) => void;
  /** Callback when a game slot is to be duplicated */
  onDuplicateGameSlot: (slotId: string) => void;
}

/**
 * DesignerCanvas component.
 * Main container that displays all fields in a responsive column layout.
 * Can switch to results entry mode to display GameResultsTable.
 */
const DesignerCanvas: React.FC<DesignerCanvasProps> = ({
  fields,
  selectedGameSlotId,
  onUpdateFieldName,
  onRemoveField,
  onAddGameSlot,
  onSelectGameSlot,
  onDeleteGameSlot,
  onDuplicateGameSlot,
}) => {
  const { resultsMode, setResultsMode, gameResults } = useGamedayContext();

  const handleToggleResultsMode = () => {
    if (resultsMode) {
      setResultsMode(false);
    } else {
      // Load game results before switching
      loadGameResults();
      setResultsMode(true);
    }
  };

  const loadGameResults = () => {
    // Fetch games from API
    // const response = await fetch(`/api/gamedays/${gamedayId}/games/`);
    // setGameResults(await response.json());
    // For now, stub that logs to console
    console.log('Loading game results...');
  };

  const handleSaveResults = async (results: Record<string, unknown>) => {
    // Stub implementation that logs to console
    console.log('Saving game results:', results);
  };

  // Show results entry mode
  if (resultsMode) {
    return (
      <div className="results-mode-container">
        <div className="mb-3">
          <Button onClick={handleToggleResultsMode} variant="secondary">
            Back to Designer
          </Button>
        </div>
        <GameResultsTable games={gameResults} onSave={handleSaveResults} />
      </div>
    );
  }

  // Show empty state when no fields
  if (fields.length === 0) {
    return (
      <Alert variant="info" className="text-center">
        <Alert.Heading>No fields yet</Alert.Heading>
        <p>Click "Add Field" in the toolbar to create your first playing field.</p>
      </Alert>
    );
  }

  // Sort fields by order
  const sortedFields = [...fields].sort((a, b) => a.order - b.order);

  return (
    <div>
      <div className="mb-3">
        <Button onClick={handleToggleResultsMode} variant="success">
          Enter Results
        </Button>
      </div>
      <Row className="g-3">
        {sortedFields.map((field) => (
          <Col
            key={field.id}
            xs={12}
            md={6}
            lg={fields.length <= 2 ? 6 : 4}
            xl={fields.length <= 3 ? 4 : 3}
          >
            <FieldColumn
              field={field}
              selectedGameSlotId={selectedGameSlotId}
              onUpdateFieldName={onUpdateFieldName}
              onRemoveField={onRemoveField}
              onAddGameSlot={onAddGameSlot}
              onSelectGameSlot={onSelectGameSlot}
              onDeleteGameSlot={onDeleteGameSlot}
              onDuplicateGameSlot={onDuplicateGameSlot}
            />
          </Col>
        ))}
      </Row>
    </div>
  );
};

export default DesignerCanvas;
