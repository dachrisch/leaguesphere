version: 2.1

orbs:
  node: circleci/node@7.2.1

commands:
  setup_uv:
    steps:
      - run:
          name: install uv
          command: |
            curl -LsSf https://astral.sh/uv/install.sh | sh
            echo 'export PATH="$HOME/.local/bin:$PATH"' >> $BASH_ENV
      - restore_cache:
          keys:
            - v2-dependencies-{{ checksum "pyproject.toml" }}
            - v2-dependencies-
      - run:
          name: install dependencies
          command: |
            uv sync --extra test
      - save_cache:
          paths:
            - .venv
          key: v2-dependencies-{{ checksum "pyproject.toml" }}

  build_docker_image:
    parameters:
      dockerfile:
        type: string
      image_name:
        type: string
    steps:
      - run:
          name: Build Docker image << parameters.image_name >>
          command: |
            export DOCKER_BUILDKIT=1
            docker build \
              --cache-from=leaguesphere/<< parameters.image_name >>:latest \
              --build-arg BUILDKIT_INLINE_CACHE=1 \
              -t << parameters.image_name >>:latest \
              -f << parameters.dockerfile >> .
            mkdir -p /tmp/docker-images
            docker save -o /tmp/docker-images/<< parameters.image_name >>.tar << parameters.image_name >>:latest
      - persist_to_workspace:
          root: /tmp
          paths:
            - docker-images/<< parameters.image_name >>.tar

  push_docker_image:
    parameters:
      image_name:
        type: string
      registry_image_name:
        type: string
      tag:
        type: string
      extra_tag:
        type: string
        default: ""
    steps:
      - attach_workspace:
          at: /tmp
      - run:
          name: Push Docker image << parameters.image_name >> to << parameters.registry_image_name >>
          command: |
            docker load -i /tmp/docker-images/<< parameters.image_name >>.tar
            echo "$DOCKER_TOKEN" | docker login -u "$DOCKER_USER" --password-stdin
            docker tag << parameters.image_name >>:latest << parameters.registry_image_name >>:<< parameters.tag >>
            docker push << parameters.registry_image_name >>:<< parameters.tag >>
            if [ -n "<< parameters.extra_tag >>" ]; then
              docker tag << parameters.image_name >>:latest << parameters.registry_image_name >>:<< parameters.extra_tag >>
              docker push << parameters.registry_image_name >>:<< parameters.extra_tag >>
            fi

  run_migrations_cmd:
    parameters:
      image_name:
        type: string
    steps:
      - attach_workspace:
          at: /tmp
      - run:
          name: Run Django Migrations
          command: |
            docker load -i /tmp/docker-images/<< parameters.image_name >>.tar
            docker run --rm \
              -e MYSQL_HOST="$MYSQL_HOST" \
              -e MYSQL_DB_NAME="$MYSQL_DB_NAME" \
              -e MYSQL_USER="$MYSQL_USER" \
              -e MYSQL_PWD="$MYSQL_PWD" \
              << parameters.image_name >>:latest \
              bash -c "set -e && python manage.py migrate --noinput"

jobs:
  python:
    docker:
      - image: cimg/python:3.14.3
      - image: cimg/mysql:9.6
        command: [ --character-set-server=utf8mb4, --collation-server=utf8mb4_unicode_ci, --default-storage-engine=InnoDB ]
        environment:
          MYSQL_DATABASE: test_test_db
          MYSQL_USER: user
          MYSQL_PASSWORD: user
    working_directory: ~/repo
    steps:
      - checkout
      - setup_uv
      - run:
          name: run tests
          environment:
            SECRET_KEY: 123456-TEST
          command: |
            uv run pytest --junitxml=test-reports/test-results.xml --cov=. --cov-report=xml --cov-report=html
      - store_test_results:
          path: test-reports

  scorecard_js:
    executor:
      name: node/default
      tag: "24.0"
    working_directory: ~/repo
    steps:
      - checkout
      - node/install-packages:
          app-dir: scorecard/
      - run:
          name: "JavaScript Test Suite"
          command: npm --prefix scorecard/ run test:run
      - run:
          name: "JavaScript Linter"
          command: |
            mkdir -p /tmp/eslint
            npm --prefix scorecard/ run eslint:junit
      - store_test_results:
          path: /tmp/eslint
      - run:
          name: "JavaScript Build"
          command: npm --prefix scorecard/ run build

  liveticker_js:
    executor:
      name: node/default
      tag: "24.0"
    working_directory: ~/repo
    steps:
      - checkout
      - node/install-packages:
          app-dir: liveticker/
      - run:
          name: "JavaScript Test Suite"
          command: npm --prefix liveticker/ run test:run
      - run:
          name: "JavaScript Linter"
          command: |
            mkdir -p /tmp/eslint
            npm --prefix liveticker/ run eslint:junit
      - store_test_results:
          path: /tmp/eslint
      - run:
          name: "JavaScript Build"
          command: npm --prefix liveticker/ run build

  passcheck_js:
    executor:
      name: node/default
      tag: "24.0"
    working_directory: ~/repo
    steps:
      - checkout
      - node/install-packages:
          app-dir: passcheck/
      - run:
          name: "JavaScript Test Suite"
          command: npm --prefix passcheck/ run test:run
      - run:
          name: "JavaScript Linter"
          command: |
            mkdir -p /tmp/eslint
            npm --prefix passcheck/ run eslint:junit
      - store_test_results:
          path: /tmp/eslint
      - run:
          name: "JavaScript Build"
          command: npm --prefix passcheck/ run build

  gameday_designer_js:
    executor:
      name: node/default
      tag: "24.0"
    working_directory: ~/repo
    steps:
      - checkout
      - node/install-packages:
          app-dir: gameday_designer/
      - run:
          name: "JavaScript Test Suite"
          command: npm --prefix gameday_designer/ run test:run
      - run:
          name: "JavaScript Linter"
          command: |
            mkdir -p /tmp/eslint
            npm --prefix gameday_designer/ run eslint:junit
      - store_test_results:
          path: /tmp/eslint
      - run:
          name: "JavaScript Build"
          command: npm --prefix gameday_designer/ run build

  dashboard_js:
    executor:
      name: node/default
      tag: "24.0"
    working_directory: ~/repo
    steps:
      - checkout
      - node/install-packages:
          app-dir: dashboard/
      - run:
          name: "JavaScript Test Suite"
          command: npm --prefix dashboard/ run test:run
      - run:
          name: "JavaScript Linter"
          command: |
            mkdir -p /tmp/eslint
            npm --prefix dashboard/ run eslint:junit
      - store_test_results:
          path: /tmp/eslint
      - run:
          name: "JavaScript Build"
          command: npm --prefix dashboard/ run build

  build_backend:
    docker:
      - image: cimg/base:stable
    working_directory: ~/repo
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.24
          docker_layer_caching: true
      - build_docker_image:
          dockerfile: container/app.Dockerfile
          image_name: backend

  build_frontend:
    docker:
      - image: cimg/base:stable
    working_directory: ~/repo
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.24
          docker_layer_caching: true
      - build_docker_image:
          dockerfile: container/nginx.Dockerfile
          image_name: frontend

  test_backend_image:
    docker:
      - image: cimg/base:stable
    steps:
      - setup_remote_docker:
          version: 20.10.24
      - attach_workspace:
          at: /tmp
      - run:
          name: Test Backend Image Health
          command: |
            docker load -i /tmp/docker-images/backend.tar
            docker network create test_network
            docker run --network test_network -d --name app mockserver/mockserver -serverPort 8000
            
            # Set expectations via container on same network
            docker run --rm --network test_network curlimages/curl -s --retry 10 --retry-connrefused http://app:8000/mockserver/status
            docker run --rm --network test_network curlimages/curl -s -X PUT \
              --data '{"httpRequest": {"method": "GET", "path": "/"}, "httpResponse": {"statusCode": 200}}' \
              http://app:8000/mockserver/expectation
            docker run --rm --network test_network curlimages/curl -s -X PUT \
              --data '{"httpRequest": {"method": "GET", "path": "/login/"}, "httpResponse": {"statusCode": 200, "headers": {"Set-Cookie": ["csrftoken=mocktoken123"]}}}' \
              http://app:8000/mockserver/expectation
            docker run --rm --network test_network curlimages/curl -s -X PUT \
              --data '{"httpRequest": {"method": "POST", "path": "/login/"}, "httpResponse": {"statusCode": 200}}' \
              http://app:8000/mockserver/expectation

            # Test health status
            docker run --rm --detach --network test_network --name test_container backend:latest gunicorn -b 0.0.0.0:8000 league_manager.wsgi
            sleep 3
            for i in {1..10}; do
              status=$(docker inspect --format='{{.State.Health.Status}}' test_container)
              echo "Health status: $status"
              if [ "$status" = "healthy" ]; then break; fi
              sleep 6
            done
            if [ "$status" != "healthy" ]; then
              echo "Container did not become healthy"
              exit 1
            fi

  test_frontend_image:
    docker:
      - image: cimg/base:stable
    steps:
      - setup_remote_docker:
          version: 20.10.24
      - attach_workspace:
          at: /tmp
      - run:
          name: Test Frontend Image Health
          command: |
            docker load -i /tmp/docker-images/frontend.tar
            docker network create test_network
            # Frontend healthcheck DOES need a backend (or mock) at http://app:8000
            docker run --network test_network -d --name app mockserver/mockserver -serverPort 8000
            
            # Wait for mockserver and set expectations via container on same network
            docker run --rm --network test_network curlimages/curl -s --retry 10 --retry-connrefused http://app:8000/mockserver/status
            docker run --rm --network test_network curlimages/curl -s -X PUT \
              --data '{"httpRequest": {"method": "GET", "path": "/login/"}, "httpResponse": {"statusCode": 200, "headers": {"Set-Cookie": ["csrftoken=mocktoken123"]}}}' \
              http://app:8000/mockserver/expectation
            docker run --rm --network test_network curlimages/curl -s -X PUT \
              --data '{"httpRequest": {"method": "POST", "path": "/login/"}, "httpResponse": {"statusCode": 200}}' \
              http://app:8000/mockserver/expectation
            
            docker run --rm --detach --network test_network --name test_container frontend:latest
            sleep 3
            for i in {1..10}; do
              status=$(docker inspect --format='{{.State.Health.Status}}' test_container)
              echo "Health status: $status"
              if [ "$status" = "healthy" ]; then break; fi
              sleep 6
            done
            if [ "$status" != "healthy" ]; then
              echo "Container did not become healthy"
              docker logs test_container
              exit 1
            fi

  check_migrations:
    docker:
      - image: cimg/base:stable
    steps:
      - setup_remote_docker:
          version: 20.10.24
      - attach_workspace:
          at: /tmp
      - run:
          name: Check Django Migrations
          command: |
            docker load -i /tmp/docker-images/backend.tar
            docker run --rm \
              -e MYSQL_HOST="$MYSQL_HOST" \
              -e MYSQL_DB_NAME="$MYSQL_DB_NAME" \
              -e MYSQL_USER="$MYSQL_USER" \
              -e MYSQL_PWD="$MYSQL_PWD" \
              backend:latest \
              bash -c "set -e && python manage.py check && python manage.py makemigrations --check --dry-run && python manage.py migrate --plan"

  test_compose_network:
    docker:
      - image: cimg/base:stable
    working_directory: ~/repo
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.24
      - attach_workspace:
          at: /tmp
      - run:
          name: Test Docker Compose Network
          command: |
            export DOCKER_BUILDKIT=1
            export COMPOSE_DOCKER_CLI_BUILD=1
            docker load -i /tmp/docker-images/backend.tar
            docker load -i /tmp/docker-images/frontend.tar
            cd deployed
            cat > .env \<<EOF
            SERVICE_NAME=leaguesphere
            COMPOSE_PROJECT_NAME=leaguesphere
            SERVICE_HOST=localhost
            LOCAL_HOSTNAME=localhost
            RUN_MIGRATIONS=false
            EOF
            cat > ls.env.ci \<<EOF
            SECRET_KEY=ci-test-secret-key-not-for-production
            MYSQL_HOST=mysql-mock.example.com
            MYSQL_DB_NAME=ci_test_db
            MYSQL_USER=ci_test_user
            MYSQL_PWD=ci_test_password
            DEBUG=False
            EOF
            sed -e 's/env_file: ls.env/env_file: ls.env.ci/g' \
                -e 's|image: leaguesphere/backend:latest|image: backend:latest|g' \
                -e 's|image: leaguesphere/frontend:latest|image: frontend:latest|g' \
                docker-compose.yaml > docker-compose.ci.yaml
            docker network create proxy || true
            docker-compose -f docker-compose.ci.yaml up -d
            sleep 15
            docker-compose -f docker-compose.ci.yaml ps
            APP_CONTAINER=$(docker-compose -f docker-compose.ci.yaml ps -q app)
            docker exec $APP_CONTAINER sh -c 'curl -f --max-time 10 https://www.google.com'
            docker-compose -f docker-compose.ci.yaml down -v

  deploy_staging:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.24
      - run:
          name: Plan a deploy
          command: |
            circleci run release plan \
              --environment-name="stage" \
              --component-name="leaguesphere" \
              --target-version="${CIRCLE_TAG}"
      - push_docker_image:
          image_name: backend
          registry_image_name: leaguesphere/backend
          tag: staging
          extra_tag: $CIRCLE_TAG
      - push_docker_image:
          image_name: frontend
          registry_image_name: leaguesphere/frontend
          tag: staging
          extra_tag: $CIRCLE_TAG
      - run:
          name: Update a deploy to SUCCESS
          command: circleci run release update --status=SUCCESS 
          when: on_success 
      - run:
          name: Update planned deploy to FAILED
          command: circleci run release update --status=FAILED 
          when: on_fail

  run_migrations_staging:
    docker:
      - image: cimg/base:stable
    steps:
      - run_migrations_cmd:
          image_name: backend

  deploy_production:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.24
      - run:
          name: Plan a deploy
          command: |
            circleci run release plan \
              --environment-name="prod" \
              --component-name="leaguesphere" \
              --target-version="${CIRCLE_TAG}"
      - push_docker_image:
          image_name: backend
          registry_image_name: leaguesphere/backend
          tag: latest
          extra_tag: $CIRCLE_TAG
      - push_docker_image:
          image_name: frontend
          registry_image_name: leaguesphere/frontend
          tag: latest
          extra_tag: $CIRCLE_TAG
      - run:
          name: Update a deploy to SUCCESS
          command: circleci run release update --status=SUCCESS 
          when: on_success 
      - run:
          name: Update planned deploy to FAILED
          command: circleci run release update --status=FAILED 
          when: on_fail

  run_migrations_production:
    docker:
      - image: cimg/base:stable
    steps:
      - setup_remote_docker:
          version: 20.10.24
      - run_migrations_cmd:
          image_name: backend

workflows:
  version: 2
  build_test_deploy:
    jobs:
      - python:
          filters:
            tags:
              only: /.*/
      - scorecard_js:
          filters:
            tags:
              only: /.*/
      - liveticker_js:
          filters:
            tags:
              only: /.*/
      - passcheck_js:
          filters:
            tags:
              only: /.*/
      - gameday_designer_js:
          filters:
            tags:
              only: /.*/
      - dashboard_js:
          filters:
            tags:
              only: /.*/

      - build_backend:
          requires:
            - python
          filters:
            tags:
              only: /.*/
      - build_frontend:
          requires:
            - scorecard_js
            - liveticker_js
            - passcheck_js
            - gameday_designer_js
            - dashboard_js
          filters:
            tags:
              only: /.*/

      - test_backend_image:
          requires:
            - build_backend
          filters:
            tags:
              only: /.*/
      - test_frontend_image:
          requires:
            - build_frontend
          filters:
            tags:
              only: /.*/
      - check_migrations:
          context: staging
          requires:
            - build_backend
          filters:
            tags:
              only: /.*/
      - test_compose_network:
          requires:
            - build_backend
            - build_frontend
            - test_backend_image
            - test_frontend_image
            - check_migrations
          filters:
            tags:
              only: /.*/

      - deploy_staging:
          context: staging
          requires:
            - test_compose_network
          filters:
            tags:
              only: /.*/
            branches:
              ignore: /.*/
      - hold_production:
          type: approval
          requires:
            - deploy_staging
          filters:
            tags:
              only: /^v?[0-9]+\.[0-9]+\.[0-9]+$/
            branches:
              ignore: /.*/
      
      - deploy_production:
          context: production
          requires:
            - hold_production
          filters:
            tags:
              only: /^v?[0-9]+\.[0-9]+\.[0-9]+$/
      - run_migrations_production:
          context: production
          requires:
            - deploy_production
          filters:
            tags:
              only: /^v?[0-9]+\.[0-9]+\.[0-9]+$/
